{# 文件路径：app/templates/admin/system_user_edit.html #}
{# 更新日期：2026-02-17 #}
{# 功能说明：用户新建/编辑页面模板，支持动态标题、只读用户名、密码提示区分、表单错误安全显示 #}

{% extends "frame_admin.html" %}

{% set show_nav = true %}
{% set show_header = false %}

{% block admin_title %}
  <h1 class="settings-title h2 mb-4">
    {% if user %}
      编辑用户：{{ user.username }}
    {% else %}
      新建用户
    {% endif %}
  </h1>
{% endblock %}

{% block admin_content %}
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-body d-flex flex-column p-4 p-md-5" style="min-height: 60vh;">

      <!-- 闪现消息 -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category in ['danger', 'error'] else 'success' }} alert-dismissible fade show mb-4" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- 表单错误汇总（添加安全检查，避免 form 未定义时崩溃） -->
      {% if form and form.errors %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          <strong>表单有 {{ form.errors|length }} 个错误，请检查：</strong>
          <ul class="mb-0">
            {% for field_name, field_errors in form.errors.items() %}
              {% for error in field_errors %}
                <li><strong>{{ form[field_name].label.text }}：</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}

      <form method="POST" novalidate class="flex-grow-1 d-flex flex-column">
        {{ form.hidden_tag() }}

        <div class="row g-4">

          <!-- 用户名 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.username.label(class="form-label fw-medium") }}
              {% if user %}
                {{ form.username(class="form-control form-control-lg", readonly=true) }}
                <small class="form-text text-muted">用户名创建后不可修改</small>
              {% else %}
                {{ form.username(class="form-control form-control-lg", autofocus=true) }}
                <small class="form-text text-muted">用于登录的唯一账号（必填）</small>
              {% endif %}
            </div>
          </div>

          <!-- 显示昵称 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.nickname.label(class="form-label fw-medium") }}
              {{ form.nickname(class="form-control form-control-lg") }}
              <small class="form-text text-muted">仪表盘、项目成员列表等处显示的名称（可留空）</small>
            </div>
          </div>

          <!-- 邮箱地址 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.email.label(class="form-label fw-medium") }}
              {{ form.email(class="form-control form-control-lg") }}
              <small class="form-text text-muted">用于密码重置和通知（可选）</small>
            </div>
          </div>

          <!-- 密码 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.password.label(class="form-label fw-medium") }}
              {{ form.password(class="form-control form-control-lg", autocomplete="new-password") }}
              <small class="form-text text-muted">
                {% if user %}
                  留空则不修改密码
                {% else %}
                  新建用户必须设置密码（至少 8 位，建议 10 位以上）
                {% endif %}
              </small>
            </div>
          </div>

          <!-- 确认密码 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.confirm_password.label(class="form-label fw-medium") }}
              {{ form.confirm_password(class="form-control form-control-lg", autocomplete="new-password") }}
              <small class="form-text text-muted">
                {% if user %}
                  修改密码时请在此再次输入新密码
                {% else %}
                  请重复输入密码以确认
                {% endif %}
              </small>
            </div>
          </div>

          <!-- 开关控件 -->
          <div class="col-12">
            <div class="row g-4">
              <div class="col-md-6">
                <div class="mt-4">
                  <div class="form-check form-switch">
                    {{ form.is_admin(class="form-check-input") }}
                    {{ form.is_admin.label(class="form-check-label fw-medium") }}
                  </div>
                  <small class="form-text text-muted mt-1">开启后拥有全部后台权限（谨慎开启）</small>
                </div>
              </div>

              <div class="col-md-6">
                <div class="mt-4">
                  <div class="form-check form-switch">
                    {{ form.is_active(class="form-check-input") }}
                    {{ form.is_active.label(class="form-check-label fw-medium") }}
                  </div>
                  <small class="form-text text-muted mt-1">
                    {% if user %}
                      当前状态：{{ '已启用' if form.is_active.data else '已禁用' }}
                    {% else %}
                      新建用户默认启用
                    {% endif %}
                  </small>
                </div>
              </div>
            </div>
          </div>

        </div>

        <!-- 底部按钮区 -->
        <div class="mt-auto pt-4 border-top d-flex justify-content-end gap-3">
          <a href="{{ url_for('admin.system_users') }}" class="btn btn-outline-secondary btn-lg px-5">
            取消
          </a>
          {{ form.submit(class="btn btn-lg px-5 primary-btn") }}
        </div>

      </form>
    </div>
  </div>
{% endblock %}
