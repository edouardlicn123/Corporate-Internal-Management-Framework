{# 文件路径：app/templates/admin/system_settings.html #}
{# 更新日期：2026-02-17 #}
{# 功能说明：系统设置页面模板，支持表单编辑与当前值显示 #}

{% extends "frame_admin.html" %}

{% set show_nav = true %}
{% set show_header = false %}

{% block admin_title %}
  <h1 class="settings-title h2 mb-4" style="display: none;">个人偏好设置</h1>
{% endblock %}

{% block admin_content %}
  <div class="card shadow-sm border-0 rounded-3">
    <div class="card-body d-flex flex-column" style="min-height: 60vh;">
      
      <!-- 闪现消息 -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category in ['danger', 'error'] else 'success' }} alert-dismissible fade show mb-4" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}

      <!-- 表单错误汇总 -->
      {% if form and form.errors %}
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
          <strong>表单有 {{ form.errors|length }} 个错误，请检查：</strong>
          <ul class="mb-0">
            {% for field_name, field_errors in form.errors.items() %}
              {% for error in field_errors %}
                <li><strong>{{ form[field_name].label.text }}：</strong> {{ error }}</li>
              {% endfor %}
            {% endfor %}
          </ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endif %}

      <form method="POST" novalidate class="flex-grow-1 d-flex flex-column">
        {{ form.hidden_tag() }}

        <div class="row g-4 mb-5">

          <!-- 上传大小限制 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.upload_max_size_mb.label(class="form-label fw-medium") }}
              <div class="input-group input-group-lg">
                {{ form.upload_max_size_mb(class="form-control") }}
                <span class="input-group-text">MB</span>
              </div>
              <small class="form-text text-muted">
                当前限制：{{ settings.upload_max_size_mb or 50 }} MB
              </small>
            </div>
          </div>

          <!-- 每个项目最大文件数（字段名已修正为 upload_max_files） -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.upload_max_files.label(class="form-label fw-medium") }}
              {{ form.upload_max_files(class="form-control form-control-lg") }}
              <small class="form-text text-muted">
                当前限制：{{ settings.upload_max_files or 20 }} 个文件/项目
              </small>
            </div>
          </div>

          <!-- 会话超时 -->
          <div class="col-md-6">
            <div class="mb-3">
              {{ form.session_timeout_minutes.label(class="form-label fw-medium") }}
              <div class="input-group input-group-lg">
                {{ form.session_timeout_minutes(class="form-control") }}
                <span class="input-group-text">分钟</span>
              </div>
              <small class="form-text text-muted">
                当前设置：{{ settings.session_timeout_minutes or 30 }} 分钟
              </small>
            </div>
          </div>

          <!-- 审计日志开关 -->
          <div class="col-md-6">
            <div class="mt-4">
              <div class="form-check form-switch form-switch-lg">
                {{ form.enable_audit_log(class="form-check-input") }}
                {{ form.enable_audit_log.label(class="form-check-label fw-medium") }}
              </div>
              <small class="form-text text-muted mt-1">
                当前状态：{{ '已启用（推荐）' if settings.enable_audit_log else '已禁用' }}
              </small>
            </div>
          </div>

          <!-- 水印文字（全宽） -->
          <div class="col-12">
            <div class="mb-3">
              {{ form.report_watermark_text.label(class="form-label fw-medium") }}
              {{ form.report_watermark_text(class="form-control form-control-lg", placeholder="例如：内部保密 - 请勿外传") }}
              <small class="form-text text-muted">
                当前水印：{{ settings.report_watermark_text or '（无水印）' }}
              </small>
            </div>
          </div>

        </div>

        <!-- 底部仅保留保存按钮 -->
        <div class="mt-auto pt-4 border-top d-flex justify-content-end">
          {{ form.submit(class="btn btn-lg px-5 primary-btn", value="保存设置") }}
        </div>

      </form>
    </div>
  </div>
{% endblock %}
