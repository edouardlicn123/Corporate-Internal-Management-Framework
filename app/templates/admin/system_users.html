{# 文件路径：app/templates/admin/system_users.html #}
{# 更新日期：2026-02-17 #}
{# 功能说明：系统用户列表页面模板，支持搜索、活跃过滤、新建按钮、表格展示、启用/禁用操作、系统管理员隐藏 #}

{% extends "frame_admin.html" %}

{% set show_nav = true %}
{% set show_header = false %}

{% block admin_title %}
  <h1 class="settings-title h2 mb-4" style="display: none;">人员管理</h1>
{% endblock %}

{% block admin_content %}
  <div class="card shadow-sm border-0 rounded-3" style="height: 100%;">
    <div class="card-body" style="height: 100%; width: 100%; padding: 1.5rem; box-sizing: border-box;">

      <!-- 闪现消息 -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mb-4">
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <!-- 操作按钮区（新建用户） -->
      <div class="d-flex justify-content-end mb-5">
        <a href="{{ url_for('admin.user_edit') }}" class="btn btn-lg px-4 primary-btn">
          <i class="bi bi-plus-lg me-2"></i> 新建用户
        </a>
      </div>

      <!-- 搜索表单（添加 form 和 form.errors 安全检查） -->
      {% if form %}
        {% if form.errors %}
          <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <strong>搜索表单有错误：</strong>
            <ul class="mb-0">
              {% for field_name, field_errors in form.errors.items() %}
                {% for error in field_errors %}
                  <li>{{ form[field_name].label.text }}：{{ error }}</li>
                {% endfor %}
              {% endfor %}
            </ul>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endif %}
      {% endif %}

      <form method="GET" class="mb-5">
        <div class="row g-4 align-items-end">
          <div class="col-md-5">
            <div class="input-group input-group-lg">
              {{ form.username(class="form-control", placeholder="用户名 / 昵称搜索...") }}
              <button class="btn btn-primary btn-lg" type="submit">
                <i class="bi bi-search me-1"></i> 搜索
              </button>
            </div>
          </div>

          <div class="col-md-4">
            <div class="form-check form-switch d-flex align-items-center h-100">
              {{ form.is_active(class="form-check-input") }}
              {{ form.is_active.label(class="form-check-label fw-medium ms-2") }}
            </div>
          </div>

          <div class="col-md-3 text-end">
            <a href="{{ url_for('admin.system_users') }}" class="btn btn-outline-secondary btn-lg">
              <i class="bi bi-arrow-repeat me-1"></i> 重置
            </a>
          </div>
        </div>
      </form>

      <!-- 表格区域 -->
      <div class="table-responsive" style="height: calc(100% - 120px); overflow-y: auto;">
        <table class="table table-hover table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>用户名</th>
              <th>昵称</th>
              <th>邮箱</th>
              <th>角色</th>
              <th>状态</th>
              <th>创建时间</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            {% if users %}
              {% for user in users %}
                {% if user.id != 1 %}
                  <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.nickname or '—' }}</td>
                    <td>{{ user.email or '—' }}</td>
                    <td>
                      {% if user.is_admin %}
                        <span class="badge bg-primary">管理员</span>
                      {% else %}
                        <span class="badge bg-secondary">普通用户</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if user.is_active %}
                        <span class="badge bg-success">启用</span>
                      {% else %}
                        <span class="badge bg-danger">禁用</span>
                      {% endif %}
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else '—' }}</td>
                    <td>
                      <a href="{{ url_for('admin.user_edit', user_id=user.id) }}" 
                         class="btn btn-outline-primary btn-sm px-2 py-1 me-2">
                        <i class="bi bi-pencil me-1"></i> 编辑
                      </a>
                      <form action="{{ url_for('admin.toggle_active', user_id=user.id) }}" 
                            method="POST" style="display:inline;">
                        <button type="submit" 
                                class="btn btn-outline-{{ 'danger' if user.is_active else 'success' }} btn-sm px-2 py-1">
                          <i class="bi bi-power me-1"></i> {{ '禁用' if user.is_active else '启用' }}
                        </button>
                      </form>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center py-5">
                  <div class="alert alert-info mb-0">
                    暂无匹配的用户记录
                  </div>
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- 记录数提示 -->
      {% if users %}
        <div class="text-end text-muted small mt-3">
          共找到 {{ users|length }} 条记录（系统管理员已隐藏）
        </div>
      {% endif %}

    </div>
  </div>
{% endblock %}
