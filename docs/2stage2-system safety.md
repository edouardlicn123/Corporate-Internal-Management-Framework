以下是一份针对“FFE 项目跟进系统”安全功能加强的**计划书**，内容聚焦于您提出的四个具体需求，不包含任何可直接运行的代码片段，但会清晰描述技术实现思路、涉及的关键组件、配置方式和注意事项。

# FFE 项目跟进系统  
安全功能加强实施计划书  
（短期基础功能补充计划 1）

**文档版本**：1.0  
**编制日期**：2026年2月11日  
**目标阶段**：基础安全加固（MVP 前必须完成的安全底线）

## 一、项目背景与目标

当前系统已实现最基础的登录认证功能，但存在以下安全隐患：

- 未登录用户可直接访问部分受保护页面
- 缺少统一的错误页面展示，错误信息暴露不友好
- 生产环境 Secret Key 使用硬编码方式，不符合安全规范
- 密码存储虽然使用了哈希，但迭代次数和算法强度有进一步提升空间

**本次计划目标**  
在不改变现有业务逻辑的前提下，快速补齐以下四个核心安全能力：

1. 强制登录保护（除登录页外全部受保护）
2. 提供标准化的错误页面（重点 401、404、500）
3. 强化密码存储的安全强度
4. 将 SECRET_KEY 改为生产环境友好的加载方式

## 二、功能需求与技术实现概要

### 2.1 强制登录保护（未登录拦截）

**目标**  
除 `/auth/login` 和 `/auth/logout` 外的所有路由，未登录访问时必须被拦截。

**技术实现要点**

- 使用 Flask-Login 提供的 `@login_manager.unauthorized_handler` 钩子统一处理未登录情况
- 推荐策略：重定向到登录页面，并携带 `next` 参数（记录原本想访问的页面）
- 替代方案（可选）：直接返回 401 状态码 + 自定义 401 错误页面
- 所有业务蓝图路由（main、project、admin 等）统一添加 `@login_required` 装饰器
- 特殊注意：静态文件、API 路由（如后续添加）需单独判断是否需要保护

### 2.2 提供标准错误页面

**目标**  
实现至少以下三种常见错误页面的美观展示：

- 401 Unauthorized（未授权 / 未登录）
- 404 Not Found（页面不存在）
- 500 Internal Server Error（服务器内部错误）

**技术实现要点**

- 使用 Flask 的 `@app.errorhandler` 装饰器注册错误处理器
- 为每种状态码创建独立的 Jinja2 模板文件，存放在 `templates/errors/` 目录下
- 模板统一继承 `base.html`，保持导航栏、footer 等一致性
- 500 错误处理器中需包含 `db.session.rollback()`，防止事务状态残留
- 开发环境（debug=True）保持原始 traceback 显示；生产环境隐藏详细错误信息
- 可选扩展：捕获所有未处理的 Exception，记录日志后统一渲染 500 页面

### 2.3 密码存储安全强化

**目标**  
确保用户密码在数据库中以高安全强度存储，抵御离线暴力破解和彩虹表攻击。

**当前状态**  
已使用 `werkzeug.security.generate_password_hash` 和 `check_password_hash`

**技术实现要点**

- 明确指定哈希算法和参数：推荐使用 `pbkdf2:sha256` 并大幅提高迭代次数（建议 500,000–1,000,000 次）
- 在 `User` 模型的 `set_password` 方法中固定使用带参数的哈希方式
- 可选增强（防暴力破解）：
  - 在 `User` 模型增加 `failed_login_attempts` 整数字段
  - 登录失败时累加计数，达到阈值（建议 5–10 次）后临时或永久禁用账号
  - 登录成功后清零计数
- 后续可考虑迁移到更强的算法（如 Argon2），但当前阶段保持 werkzeug 兼容性

### 2.4 SECRET_KEY 生产环境适配

**目标**  
杜绝硬编码密钥，确保密钥在生产环境安全、唯一、不可预测。

**技术实现要点**

- 在 `config.py` 中修改 SECRET_KEY 的获取方式：
  - 优先读取环境变量 `SECRET_KEY`
  - 开发环境提供一个默认值（仅用于本地调试）
- 生产环境密钥生成建议：
  - 使用操作系统提供的强随机数生成器
  - 长度建议 32 字节（64 位十六进制）
  - 典型生成命令示例：`python -c "import secrets; print(secrets.token_hex(32))"`
- 部署方式推荐：
  - Docker：通过环境变量注入
  - 系统服务：写入 `.env` 文件或 systemd 环境文件
  - 严禁将生产密钥提交到 git

## 三、实施优先级与分步计划

| 优先级 | 任务项                              | 预计耗时 | 依赖项               | 完成标志                              |
|--------|-------------------------------------|----------|----------------------|---------------------------------------|
| 1      | 修改 config.py 中的 SECRET_KEY 读取方式 | 10分钟   | 无                   | 开发环境仍可启动，生产需环境变量      |
| 2      | 在 User 模型中强化密码哈希参数      | 15分钟   | models.py            | set_password 方法明确指定迭代次数     |
| 3      | 为所有业务路由添加 @login_required  | 20–40分钟| 各蓝图文件           | 未登录访问 dashboard 等页面被拦截     |
| 4      | 实现 unauthorized_handler           | 15分钟   | __init__.py          | 未登录访问时统一跳转登录页或错误页    |
| 5      | 创建并注册 401/404/500 错误处理器   | 30分钟   | __init__.py + templates | 手动访问不存在页面或未登录页面显示对应模板 |
| 6      | （可选）增加登录失败次数计数与账号锁定逻辑 | 40分钟   | models.py + auth_service | 连续错误登录5次后账号被禁用           |
| 7      | 测试全流程（开发 & 模拟生产环境）   | 60分钟   | —                    | 所有场景均符合预期，无明显安全漏洞    |

## 四、验收标准

1. 未登录状态下访问任何受保护页面，必须被重定向到登录页或显示 401 页面
2. 访问不存在的 URL，显示美观的 404 页面
3. 触发服务器内部错误（可模拟），显示 500 页面，且不泄露敏感信息
4. 新注册或修改密码后，数据库中存储的是哈希值，且使用高迭代次数算法
5. 开发环境可正常启动，生产环境必须通过环境变量提供 SECRET_KEY

## 五、风险与注意事项

- 所有新增的错误页面模板需适配移动端（响应式）
- 生产环境必须关闭 `app.debug = True`
- 后续引入 API 接口时，需为 API 单独设计认证方式（JWT 或 Token）
- 建议在完成本轮安全加固后，尽快引入 CSRF 保护验证（Flask-WTF 已内置）
- 考虑记录关键安全事件日志（登录失败、账号锁定等）

如需进一步细化某部分内容、调整优先级或增加其他安全项，请随时告知。

**计划书完**
